/*
rlwrap sqlplus cbourdeau/azertyui@venus/licence
Fichier tables.sql
21507569, Bourdeau, Clement
*/
DROP TRIGGER `covoit_trajet_type`;
CREATE TRIGGER `covoit_trajet_type` 
BEFORE INSERT ON `COVOITURAGE` FOR EACH ROW
INSERT INTO TRAJET_TYPE (VILLE_DEPART,VILLE_ARRIVEE,TPS_MOYEN,PRIX) VALUES (NEW.V_DEPART,NEW.V_ARRIVEE,NEW.DUREE,NEW.PRIX);

/*
	IF (:NEW.V_DEPART NOT IN (SELECT VILLE_DEPART FROM TRAJET_TYPE))
	AND (:NEW.V_ARRIVEE NOT IN (SELECT VILLE_ARRIVEE FROM TRAJET_TYPE))
DECLARE
	DEP VARCHAR(30);
	ARR VARCHAR(30);
	TPS INT;
	P INT;
SELECT NEW.V_DEPART, NEW.V_ARRIVEE, NEW.DUREE, NEW.PRIX
	INTO DEP, ARR, TPS, P
	FROM COVOITURAGE;
INSERT INTO TRAJET_TYPE(VILLE_DEPART,VILLE_ARRIVEE,TPS_MOYEN,PRIX)
	VALUES(NEW.V_DEPART,.NEW.V_ARRIVEE,NEW.DUREE,NEW.PRIX)
	FROM COVOITURAGE,TRAJET_TYPE
	WHERE NEW.VILLE_DEPART NOT IN (SELECT V_DEPART FROM TRAJET_TYPE)
	AND NEW.VILLE_ARRIVEE NOT IN (SELECT V_ARRIVEE FROM TRAJET_TYPE);
*/


CREATE TRIGGER nouveau_passager
AFTER INSERT ON INSCRIPTION 
DECLARE
	nbpass NUMERIC(1),
BEGIN
	SELECT NB_PLACES_DISPO
	INTO nbpass
	FROM COVOITURAGE,INSCRIPTION
	WHERE TRAJET=NUMCOVOIT;
	UPDATE COVOITURAGE
	SET NB_PLACES_DISPO=nbpass-1; 
END ;
/
-- nbpassagers <= nbplaces véhicule

/*

s'assurer que l'on ne dépasse pas le nbplace de la voiture
a mettre dans un trigger

*/

--procedures

/*

ajouter un vehicule a un utilisateur

*/

